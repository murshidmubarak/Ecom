<%- include("../../views/partials/user/header") %>

<section class="content-main d-flex justify-content-center align-items-center min-vh-100 px-3">
  <div class="card col-12 col-sm-10 col-md-8 col-lg-6 shadow p-4">
    <div class="card-body">

      <h4 class="text-center mb-4">Update Email</h4>

      <form id="updateEmailForm">
        <input type="hidden" id="csrfToken" value="<%= csrfToken %>">

        <!-- Row -->
        <div class="row g-3">

          <!-- Password -->
          <div class="col-12 col-md-6">
            <label class="form-label">enter your password</label>
            <input
              type="password"
              id="password"
              class="form-control"
              placeholder="Enter your password"
            />
          </div>

          <!-- New Email -->
          <div class="col-12 col-md-6">
            <label class="form-label">enter new email</label>
            <input
              type="text"
              id="email"
              class="form-control"
              placeholder="Enter new email"
            />
          </div>

        </div>

        <button id="submitBtn" class="btn btn-primary w-100 mt-4" type="submit">
          Update Email
        </button>
      </form>

    </div>
  </div>
</section>

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.getElementById("updateEmailForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const password = document.getElementById("password").value.trim();
  const email = document.getElementById("email").value.trim();
  const csrfToken = document.getElementById("csrfToken").value;
  const submitBtn = document.getElementById("submitBtn");

  if (!password || !email) {
    return Swal.fire({
      icon: "warning",
      title: "Missing Fields",
      text: "Both password and email are required"
    });
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return Swal.fire({
      icon: "error",
      title: "Invalid Email",
      text: "Please enter a valid email address"
    });
  }

  submitBtn.disabled = true;
  submitBtn.textContent = "Sending OTP...";

  try {
    const res = await fetch("/change-email", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "CSRF-Token": csrfToken
      },
      body: JSON.stringify({
        password,
        newEmail: email
      })
    });

    const data = await res.json();

    if (!res.ok) {
      return Swal.fire({
        icon: "error",
        title: "Update Failed",
        text: data.message || "Something went wrong"
      });
    }

    await Swal.fire({
      icon: "success",
      title: "OTP Sent",
      text: data.message || "OTP sent successfully"
    });

    if (data.redirectUrl) {
      window.location.href = data.redirectUrl;
    }

  } catch (err) {
    Swal.fire({
      icon: "error",
      title: "Server Error",
      text: "Please try again later"
    });
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "Update Email";
  }
});
</script>


<%- include("../../views/partials/user/footer") %>
