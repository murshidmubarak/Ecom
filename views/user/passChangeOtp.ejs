<%- include("../../views/partials/user/header") %>

<meta name="csrf-token" content="<%= csrfToken %>">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body {
    background: #ffffff;
    min-height: 100vh;
  }

  .otp-container {
    max-width: 420px;
    width: 100%;
    margin: auto;
    padding: 16px;
    padding-top: 100px;
  }

  .card {
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }

  .otp-inputs {
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  .otp-inputs input {
    width: 48px;
    height: 56px;
    text-align: center;
    font-size: 22px;
    border-radius: 6px;
    border: 1px solid #ccc;
    outline: none;
    transition: 0.2s;
  }

  .otp-inputs input:focus {
    border-color: #0066cc;
    box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2);
  }

  .timer-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
  }

  @media (max-width: 480px) {
    .otp-inputs {
      gap: 6px;
    }

    .otp-inputs input {
      width: 40px;
      height: 48px;
      font-size: 18px;
    }

    .timer-circle {
      width: 42px;
      height: 42px;
      font-size: 14px;
    }
  }
</style>

<div class="container">
  <div class="otp-container d-flex align-items-center justify-content-center" style="min-height:100vh;">
    <div class="card w-100 p-4 text-center">

      <h4 class="mb-2">Verify OTP</h4>
      <p class="text-muted">Enter the 6-digit OTP sent to your email</p>

      <form id="otpForm">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">

        <div class="otp-inputs mb-3">
          <input type="text" maxlength="1" class="otp" inputmode="numeric" />
          <input type="text" maxlength="1" class="otp" inputmode="numeric" />
          <input type="text" maxlength="1" class="otp" inputmode="numeric" />
          <input type="text" maxlength="1" class="otp" inputmode="numeric" />
          <input type="text" maxlength="1" class="otp" inputmode="numeric" />
          <input type="text" maxlength="1" class="otp" inputmode="numeric" />
        </div>

        <button type="submit" class="btn btn-primary w-100">
          Verify OTP
        </button>
      </form>

      <!-- Timer -->
      <div class="mt-3 d-flex justify-content-center">
        <div class="timer-circle">
          <span id="timer">60</span>
        </div>
      </div>

      <button id="resendBtn" class="btn btn-secondary w-100 mt-3" disabled>
        Resend OTP
      </button>

      <!-- <p class="mt-3 text-muted">
        Remember password?
        <a href="/login" class="text-primary">Login</a>
      </p> -->

    </div>
  </div>
</div>

<script>
  const inputs = document.querySelectorAll(".otp");
  const form = document.getElementById("otpForm");
  const resendBtn = document.getElementById("resendBtn");
  const timerEl = document.getElementById("timer");

  // Auto focus handling
  inputs.forEach((input, index) => {
    input.addEventListener("input", () => {
      if (input.value && index < inputs.length - 1) {
        inputs[index + 1].focus();
      }
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && !input.value && index > 0) {
        inputs[index - 1].focus();
      }
    });
  });

  // Timer logic
  let time = 60;
  let interval;

  function startTimer() {
    time = 60;
    resendBtn.disabled = true;
    timerEl.textContent = time;

    interval = setInterval(() => {
      time--;
      timerEl.textContent = time;

      if (time <= 0) {
        clearInterval(interval);
        resendBtn.disabled = false;
      }
    }, 1000);
  }

  startTimer();

  // Verify OTP
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const otp = Array.from(inputs).map(i => i.value).join("");

    if (!/^\d{6}$/.test(otp)) {
      return Swal.fire("Invalid OTP", "Enter a valid 6-digit OTP", "error");
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    try {
      const res = await fetch("/verifyEmailPassOtp", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "CSRF-Token": csrfToken
        },
        body: JSON.stringify({ otp })
      });

      const data = await res.json();

      if (data.success) {
        Swal.fire({
          icon: "success",
          title: "OTP Verified",
          timer: 1500,
          showConfirmButton: false
        }).then(() => {
          window.location.href = data.redirectUrl || "/";
        });
      } else {
        Swal.fire("Invalid OTP", data.message || "Try again", "error");
      }
    } catch (err) {
      Swal.fire("Error", "Something went wrong", "error");
    }
  });

  // Resend OTP
  resendBtn.addEventListener("click", async () => {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    Swal.fire({
      title: "Sending OTP...",
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    try {
      const res = await fetch("/resend-pass-otp", {
        method: "POST",
        headers: { "CSRF-Token": csrfToken }
      });

      const data = await res.json();

      if (data.success) {
        Swal.fire("Success", "OTP resent successfully", "success");
        clearInterval(interval);
        startTimer();
      } else {
        Swal.fire("Error", data.message || "Failed to resend OTP", "error");
      }
    } catch {
      Swal.fire("Error", "Server error", "error");
    }
  });
</script>

<%- include("../../views/partials/user/footer") %>
