<%- include("../../views/partials/user/header") %>

<style>
  .profile-container {
    margin-top: 100px;
    margin-bottom: 50px;
    min-height: calc(100vh - 150px);
  }
  
  .card-green {
    background-color: #ADD8E6;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .card-green:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
  }
  
  .dashboard-menu {
    background-color: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    height: 100%;
  }
  
  .dashboard-menu .nav-link {
    font-weight: 600;
    color: #495057;
    margin-bottom: 10px;
    border-radius: 5px;
    padding: 10px 15px;
    transition: all 0.3s ease;
  }
  
  .dashboard-menu .nav-link:hover,
  .dashboard-menu .nav-link.active {
    color: #ffffff;
    background-color: #487379;
    box-shadow: 0 4px 8px rgba(72, 115, 121, 0.3);
  }
  
  .dashboard-menu .nav-link i {
    margin-right: 10px;
  }
  
  .card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 25px;
    transition: transform 0.3s ease;
  }
  
  .card:hover {
    transform: translateY(-5px);
  }
  
  .card-header {
    background-color: #487379;
    color: white;
    border-radius: 10px 10px 0 0;
    padding: 15px 20px;
    font-weight: 600;
  }
  
  .btn-success {
    background-color: #577194;
    border-color: #577194;
    padding: 8px 20px;
    border-radius: 5px;
    transition: all 0.3s ease;
  }
  
  .btn-success:hover {
    background-color: #3a5a7a;
    border-color: #3a5a7a;
    transform: translateY(-2px);
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
  }
  
  .breadcrumb-wrap {
    background-color: #f8f9fa;
    padding: 15px 0;
    margin-bottom: 30px;
  }
  
  .breadcrumb {
    padding: 0;
    background-color: transparent;
    font-size: 14px;
  }
  
  .breadcrumb a {
    color: #487379;
    text-decoration: none;
    transition: color 0.3s ease;
  }
  
  .breadcrumb a:hover {
    color: #3a5a7a;
    text-decoration: underline;
  }
  
  .table-responsive {
    border-radius: 10px;
    overflow: hidden;
  }
  
  .table {
    margin-bottom: 0;
  }
  
  .table th {
    background-color: #487379;
    color: white;
  }
  
  .table td, .table th {
    vertical-align: middle;
    padding: 12px 15px;
  }
  
  .table tr:nth-child(even) {
    background-color: #f8f9fa;
  }
  
  .btn-small {
    padding: 5px 10px;
    font-size: 13px;
    border-radius: 4px;
  }

  /* Referral Section Styles */
  .referral-section {
    text-align: center;
    padding: 20px;
  }
  .referral-code {
    font-size: 24px;
    font-weight: bold;
    color: #487379;
    margin: 20px 0;
  }
  .copy-btn {
    background-color: #577194;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
  }
  .copy-btn:hover {
    background-color: #3a5a7a;
  }
  .referral-stats p {
    font-size: 16px;
    margin: 10px 0;
  }
</style>

<div class="profile-container">
  <div class="page-header breadcrumb-wrap mb-4">
    <div class="container">
      <div class="breadcrumb">
        <a href="/" rel="nofollow">Home</a>
        <span>/</span> Profile <span>/</span> Account
      </div>
    </div>
  </div>
  
  <section class="pt-2 pb-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="row">
            <div class="col-md-4">
              <div class="dashboard-menu">
                <ul class="nav flex-column" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="true">
                      <i class="fi-rs-settings-sliders mr-10"></i>Dashboard
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="false">
                      <i class="fi-rs-marker mr-10"></i>My Address
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false">
                      <i class="fi-rs-shopping-bag mr-10"></i>Orders
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="wallet-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false">
                      <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet Status
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="wallet-history-tab" data-bs-toggle="tab" href="#wallet-history" role="tab" aria-controls="wallet-history" aria-selected="false">
                      <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet History
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="referral-tab" data-bs-toggle="tab" href="#referral" role="tab" aria-controls="referral" aria-selected="false">
                      <i class="fi-rs-shopping-cart-check mr-10"></i>Referrals
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="/logout">
                      <i class="fi-rs-sign-out mr-10"></i>Logout
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            
            <div class="col-md-8">
              <div class="tab-content dashboard-content">
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                  <div class="card card-green">
                    <div class="card-header">
                      <h5 class="mb-0 text-center">User Profile</h5>
                    </div>
                    <div class="card-body text-center">
                      <div class="mb-4">
                        <i class="fi-rs-user" style="font-size: 48px; color: #487379;"></i>
                      </div>
                      <h5 class="card-title"><%= user.name %></h5>
                      <p class="card-text">
                        <strong>Phone:</strong> <%= user.phone || 'Not provided' %>
                      </p>
                      <p class="card-text">
                        <strong>Email:</strong> <%= user.email %>
                      </p>
                      <div class="d-flex justify-content-center flex-wrap mt-4">
                        <a href="/change-email" class="btn btn-success mx-2 mb-2">Change Email</a>
                        <a href="/change-password" class="btn btn-success mx-2 mb-2">Change Password</a>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                  <div class="row">
                    <% if (userAddress && userAddress.address && userAddress.address.length > 0) { %>
                      <% userAddress.address.forEach(address => { %>
                        <div class="col-lg-6">
                          <div class="card mb-3">
                            <div class="card-header">
                              <h5 class="mb-0"><%= address.addressType || 'Address' %></h5>
                            </div>
                            <div class="card-body">
                              <address>
                                <%= address.name || 'N/A' %><br>
                                <%= address.city || '' %>, <%= address.state || '' %><br>
                                <%= address.landMark || '' %><br>
                                PIN: <%= address.pincode || 'N/A' %>
                              </address>
                              <p>Phone: <%= address.phone || 'N/A' %></p>
                              <% if (address.altPhone) { %>
                                <p>Alt: <%= address.altPhone %></p>
                              <% } %>
                              <div class="d-flex justify-content-between mt-3">
                                <a href="/editAddress?id=<%= address._id %>" class="btn btn-sm btn-success">Edit</a>
                                <a href="/deleteAddress?id=<%= address._id %>" 
                                   class="btn btn-sm btn-outline-danger"
                                   onclick="return confirm('Are you sure you want to delete this address?')">Delete</a>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% }) %>
                    <% } else { %>
                      <div class="col-12">
                        <div class="card">
                          <div class="card-body text-center">
                            <p class="text-muted">No addresses saved</p>
                          </div>
                        </div>
                      </div>
                    <% } %>
                    <div class="col-lg-6">
                      <div class="card">
                        <div class="card-header">
                          <h5 class="mb-0">Add New Address</h5>
                        </div>
                        <div class="card-body text-center">
                          <i class="fi-rs-marker" style="font-size: 48px; color: #487379; margin-bottom: 15px;"></i>
                          <a href="/addAddress" class="btn btn-success">Add Address</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                  <div class="card">
                    <div class="card-header">
                      <h5 class="mb-0">Your Orders</h5>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover">
                          <thead>
                            <tr>
                              <th>Products</th>
                              <th>Date</th>
                              <th>Status</th>
                              <th>Total</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% if (orders && orders.length > 0) { %>
                              <% orders.forEach(order => { %>
                                <tr>
                                  <td>
                                    <%= order.orderedItems.map(item => item.product.productName).join(', ') %>
                                  </td>
                                  <td><%= order.createdOn.toLocaleDateString() %></td>
                                  <td><%= order.status %></td>
                                  <td>₹<%= order.finalAmount.toFixed(2) %></td>
                                  <td>
                                    <a href="/orderDetails?id=<%= order._id %>" class="btn btn-small btn-success">View Details</a>
                                  </td>
                                </tr>
                              <% }) %>
                            <% } else { %>
                              <tr>
                                <td colspan="5" class="text-center text-muted">No orders found</td>
                              </tr>
                            <% } %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="wallet-tab">
                  <div class="card">
                    <div class="card-header">
                      <h5 class="mb-0">Wallet Status</h5>
                    </div>
                    <div class="card-body">
                      <!-- Debug: Raw walletBalance value -->
                      <p class="text-muted"> walletBalance = <%= walletBalance %></p>
                      <% if (wallet && typeof walletBalance === 'number') { %>
                        <div class="row align-items-center">
                          <div class="col-md-6">
                            <h6>Current Balance: ₹<%= walletBalance.toFixed(2) %></h6>
                            <p class="text-muted">
                              Last Updated: <%= moment(wallet.updatedAt || Date.now()).format('DD MMM YYYY, hh:mm A') %>
                            </p>
                          </div>
                          <div class="col-md-6 text-end">
                            <a href="/add-to-wallet" class="btn btn-success">Add Funds</a>
                          </div>
                        </div>
                      <% } else { %>
                        <div class="text-center">
                          <p class="text-muted">Your wallet is empty. Start by adding funds or earning rewards!</p>
                          <a href="/add-to-wallet" class="btn btn-success">Add Funds</a>
                        </div>
                      <% } %>
                    </div>
                  </div>
                </div>

                <div class="tab-pane fade" id="wallet-history" role="tabpanel" aria-labelledby="wallet-history-tab">
                  <div class="card">
                    <div class="card-header">
                      <h5 class="mb-0">Wallet History</h5>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover">
                          <thead>
                            <tr>
                              <th>Transaction ID</th>
                              <th>Date</th>
                              <th>Type</th>
                              <th>Description</th>
                              <th>Amount</th>
                              <th>Balance After</th>
                              <th>Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% if (wallet && wallet.transactions && wallet.transactions.length > 0) { %>
                              <% wallet.transactions.forEach(transaction => { %>
                                <tr>
                                  <td><%= transaction.transactionId %></td>
                                  <td><%= moment(transaction.transactionDate).format('DD MMM YYYY, hh:mm A') %></td>
                                  <td><%= transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1) %></td>
                                  <td><%= transaction.description.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) %></td>
                                  <td>₹<%= transaction.amount.toFixed(2) %></td>
                                  <td>₹<%= transaction.balanceAfter.toFixed(2) %></td>
                                  <td><%= transaction.status.charAt(0).toUpperCase() + transaction.status.slice(1) %></td>
                                </tr>
                              <% }) %>
                            <% } else { %>
                              <tr>
                                <td colspan="7" class="text-center text-muted">No wallet transactions found</td>
                              </tr>
                            <% } %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="tab-pane fade" id="referral" role="tabpanel" aria-labelledby="referral-tab">
                  <div class="card">
                    <div class="card-header">
                      <h5 class="mb-0">Referrals</h5>
                    </div>
                    <div class="card-body referral-section">
                      <p>Invite friends and earn ₹100 for each successful referral!</p>
                      <div class="referral-code" id="referralCode">
                        <%= user.referalCode || 'Not available' %>
                      </div>
                      <button class="copy-btn" onclick="copyReferralCode()" <%= !user.referalCode ? 'disabled' : '' %>>Copy Code</button>
                      <div class="referral-stats">
                        <p><strong>Successful Referrals:</strong> <%= user.redeemedUsers ? user.redeemedUsers.length : 0 %></p>
                        <p><strong>Total Earnings:</strong> ₹<%= user.redeemedUsers ? user.redeemedUsers.length * 100 : 0 %></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function copyReferralCode() {
    const referralCode = document.getElementById("referralCode").innerText;
    if (referralCode === 'Not available') {
      alert("No referral code available to copy.");
      return;
    }
    navigator.clipboard.writeText(referralCode).then(() => {
      alert("Referral code copied to clipboard!");
    }).catch((err) => {
      console.error("Failed to copy:", err);
      alert("Failed to copy referral code.");
    });
  }
</script>

<%- include("../../views/partials/user/footer") %>